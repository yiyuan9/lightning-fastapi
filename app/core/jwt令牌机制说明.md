

Token-Based Authentication 流程图

+----------------------------------------+
|   Mobile App (Client)                  |
+----------------------------------------+
| 1. 用户通过手机号和密码请求登录          |
|       ↓                                |
| 2. 服务端验证用户凭据                   |
|       ↓                                |
| 3. 生成JWT访问令牌并返回给客户端         |
|       ↓                                |
| 4. 客户端保存令牌并在每次请求时附加       |
+----------------------------------------+
               ↓
+----------------------------------------+
|           服务端 (API)                 |
+----------------------------------------+
| 5. 接收并验证JWT令牌                     |
| 6. 根据令牌的用户ID授权访问资源           |
+----------------------------------------+

代码功能模块拆解图

+---------------------------------------------+
| 密码处理模块                                |
|---------------------------------------------|
| 函数: verify_password()                     |
| 函数: get_password_hash()                   |
| 功能: 验证密码或生成密码哈希                |
+---------------------------------------------+

+---------------------------------------------+
| 用户认证模块                                |
|---------------------------------------------|
| 函数: authenticate()                        |
| 功能: 验证手机号和密码，返回用户对象         |
+---------------------------------------------+

+---------------------------------------------+
| 令牌生成模块                                |
|---------------------------------------------|
| 函数: create_access_token()                 |
| 功能: 使用用户ID生成JWT访问令牌             |
+---------------------------------------------+

+---------------------------------------------+
| 登录流程入口                                |
|---------------------------------------------|
| 函数: make_token_for_user_to_login()        |
| 功能: 调用create_access_token生成令牌       |
+---------------------------------------------+

核心概念解释

	1.	JWT（JSON Web Token）
	•	用途: 用于认证和授权。
	•	结构: 由三部分组成，格式为 Header.Payload.Signature。
	•	Header: 指定算法和令牌类型。
	•	Payload: 存储用户信息和过期时间。
	•	Signature: 防篡改签名，由密钥和算法生成。
	2.	加密与哈希
	•	bcrypt: 用于对密码进行单向加密，保护用户密码。
	•	密码验证: 使用 verify_password 对用户输入和数据库密码进行匹配。
	3.	令牌过期机制
	•	通过 exp 设置令牌过期时间，确保令牌不会被无限期使用。
	4.	移动端存储
	•	安全性提示: 将令牌存储在设备安全区域，例如 iOS 的 Keychain 或 Android 的 Keystore。

详细代码流程

1. 用户登录 (authenticate):
   - 用户提供手机号和密码，调用 `authenticate()`。
   - 查找数据库用户记录，如果用户不存在或密码不匹配，则返回 None。
   
2. 生成JWT令牌 (create_access_token):
   - 调用 `create_access_token()`，通过用户ID和过期时间生成JWT。
   - 使用HMAC-SHA256算法 (`HS256`) 对令牌进行签名。

3. 返回给客户端 (make_token_for_user_to_login):
   - 将生成的令牌返回给客户端，用于后续API请求中的身份验证。

如何在移动端使用

	1.	登录接口调用
	•	提交手机号和密码。
	•	接收返回的JWT令牌。
	2.	存储令牌
	•	将令牌存储在安全位置（如Keychain/Keystore）。
	3.	后续请求附带令牌
	•	每次API请求时，在HTTP Header中添加令牌：

Authorization: Bearer <Token>


	4.	处理令牌过期
	•	检测401错误（Unauthorized），引导用户重新登录获取新令牌。

通过这些注释和图表，读者可以清晰理解移动端登录和Token机制的核心流程与实现细节。