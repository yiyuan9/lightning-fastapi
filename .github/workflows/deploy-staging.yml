# .github/workflows/deploy-staging.yml
name: Deploy to Staging

on:
  push:
    branches:
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Debug - List all files
      run: |
        echo "ğŸ” Checking current directory... | æ£€æŸ¥å½“å‰ç›®å½•æ–‡ä»¶..."
        echo "Current directory contents (including hidden files):"
        ls -la
        
    - name: Create deployment package
      run: |
        echo "ğŸ“¦ Creating deployment package... | å¼€å§‹æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶..."
        # Create temporary directory | åˆ›å»ºä¸´æ—¶ç›®å½•
        echo "ğŸ“ Creating temporary directory... | åˆ›å»ºä¸´æ—¶ç›®å½•..."
        mkdir ../temp_deploy
        
        # Copy files to temporary directory | å¤åˆ¶æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        echo "ğŸ“‹ Copying files... | å¤åˆ¶æ–‡ä»¶..."
        cp -a . ../temp_deploy/
        
        # Create compressed package | åˆ›å»ºå‹ç¼©åŒ…
        echo "ğŸ—œï¸ Creating archive... | åˆ›å»ºå‹ç¼©åŒ…..."
        cd ../temp_deploy
        tar -czf ../package.tgz .
        cd -
        mv ../package.tgz .
        
        echo "âœ… Package created. Contents: | æ‰“åŒ…å®Œæˆ. å†…å®¹:"
        tar -tvf package.tgz
        
    - name: Install SSH key
      run: |
        echo "ğŸ”‘ Setting up SSH key... | é…ç½® SSH å¯†é’¥..."
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        
    - name: Transfer and extract package
      run: |
        echo "ğŸ“¤ Transferring files to server... | ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
        scp package.tgz ubuntu@${{ secrets.SERVER_IP }}:/home/ubuntu/app/package.tgz
        
        echo "ğŸ“‚ Extracting files... | è§£å‹æ–‡ä»¶..."
        ssh ubuntu@${{ secrets.SERVER_IP }} '
          cd /home/ubuntu/fastapi-starter
          echo "ğŸ—‘ï¸ Cleaning old files... | æ¸…ç†æ—§æ–‡ä»¶..."
          rm -rf * .[!.]*
          echo "ğŸ“¨ Extracting new files... | è§£å‹æ–°æ–‡ä»¶..."
          tar -xzf /home/ubuntu/app/package.tgz --strip-components=1
          echo "ğŸ“‹ Showing extracted contents: | æ˜¾ç¤ºè§£å‹å†…å®¹:"
          ls -la
        '
        
    - name: Execute deployment script
      run: |
        echo "ğŸš€ Starting deployment... | å¼€å§‹éƒ¨ç½²..."
        ssh ubuntu@${{ secrets.SERVER_IP }} '
          # Ensure script is executable | ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
          echo "ğŸ”§ Setting script permissions... | è®¾ç½®è„šæœ¬æƒé™..."
          chmod +x /home/ubuntu/fastapi-starter/deploy.sh
          
          # Execute deployment script | æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          echo "â–¶ï¸ Executing deployment script... | æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
          cd /home/ubuntu/fastapi-starter
          ./deploy.sh
        '
        
    - name: Verify deployment
      if: success()
      run: |
        echo "âœ… Verifying deployment... | éªŒè¯éƒ¨ç½²..."
        ssh ubuntu@${{ secrets.SERVER_IP }} '
          echo "ğŸ“ Directory contents: | ç›®å½•å†…å®¹:"
          ls -la /home/ubuntu/fastapi-starter/
          echo "ğŸ“„ Checking .env file: | æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶:"
          cat /home/ubuntu/fastapi-starter/.env.staging
          echo "ğŸ³ Docker containers: | Docker å®¹å™¨çŠ¶æ€:"
          docker ps
        '

    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up... | æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f ~/.ssh/id_rsa
        rm -rf ../temp_deploy
        echo "âœ¨ Deployment process completed | éƒ¨ç½²æµç¨‹ç»“æŸ"